<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tafels 1–20 Trainer</title>
    <meta name="theme-color" content="#0f172a" />
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="icon" sizes="192x192" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial; background: linear-gradient(#f8fafc,#f1f5f9); color:#0f172a; }
      .container { max-width: 64rem; margin: 0 auto; padding: 2rem 1rem; }
      .row { display:flex; gap:.5rem; }
      .btn { padding:.5rem .75rem; border-radius:12px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; }
      .btn.primary { background:#0f172a; color:#fff; border-color:#0f172a; }
      .card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:1rem; }
      .grid { display:grid; gap: .5rem; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
      .chips { display:grid; grid-template-columns: repeat(5,1fr); gap:.5rem; }
      input, select { padding:.5rem; border:1px solid #cbd5e1; border-radius:12px; }
      .pill { padding:.5rem .75rem; border:1px solid #e2e8f0; border-radius:12px; background:#f8fafc; display:flex; justify-content:space-between; }
      .progress { width:100%; height:12px; background:#e2e8f0; border-radius:999px; overflow:hidden; }
      .bar { height:100%; background:#0f172a; transition: width .2s; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js');
        });
      }
    </script>
    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
      const ALL_NUMBERS = Array.from({ length: 20 }, (_, i) => i + 1);
      const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
      function useLocalStorage(key, initialValue) {
        const [state, setState] = useState(() => {
          try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; }
          catch { return initialValue; }
        });
        useEffect(() => { try { window.localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
        return [state, setState];
      }
      const makePoolSingle = (t) => ALL_NUMBERS.map(m => [t,m]);
      function makePoolMixed(){ const p=[]; for(let a of ALL_NUMBERS){ for(let b of ALL_NUMBERS){ p.push([a,b]); } } return p; }
      const shuffle = (arr)=>{ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
      
      function App(){
        const [mode, setMode] = useLocalStorage("tafels.mode","single");
        const [selectedTable, setSelectedTable] = useLocalStorage("tafels.table",1);
        const [uniqueOnly, setUniqueOnly] = useLocalStorage("tafels.uniqueOnly", true);
        const [questionLimit, setQuestionLimit] = useLocalStorage("tafels.limit", 20);
        const [mistakeBank, setMistakeBank] = useLocalStorage("tafels.mistakeBank", {});
        const [current, setCurrent] = useLocalStorage("tafels.current", {a:1,b:1});
        const [answer, setAnswer] = useState("");
  const inputRef = useRef(null);
  // Auto-advance when the answer matches a*b
  const autoOnceRef = useRef(false);
  useEffect(() => {
    const correct = Number(current.a) * Number(current.b);
    const val = Number(answer);
    if (!finished && String(answer).length > 0 && val === correct && !autoOnceRef.current) {
      autoOnceRef.current = true;
      // let React commit state before moving on
      setTimeout(() => {
        try { check(); } finally {
          // release the lock shortly after moving to next
          setTimeout(() => { autoOnceRef.current = false; }, 120);
        }
      }, 0);
    }
  }, [answer, current, finished]);
        const [asked, setAsked] = useLocalStorage("tafels.asked", []);
        const [correctCount, setCorrectCount] = useLocalStorage("tafels.correct", 0);
        const [wrong, setWrong] = useLocalStorage("tafels.wrong", []);
        const [totalAsked, setTotalAsked] = useLocalStorage("tafels.totalAsked", 0);
        const [finished, setFinished] = useLocalStorage("tafels.finished", false);
        
        const pool = useMemo(()=>{
          if(mode==="single") return makePoolSingle(Number(selectedTable));
          if(mode==="mixed") return makePoolMixed();
          const entries = Object.entries(mistakeBank).filter(([,c])=>c>0).map(([k,c])=>{
            const [a,b] = k.split("x").map(Number); return {a,b,c};
          });
          const weighted=[]; for(const {a,b,c} of entries){ for(let i=0;i<c;i++) weighted.push([a,b]); }
          return weighted.length? weighted: [];
        },[mode, selectedTable, mistakeBank]);
        
        const poolSize = useMemo(()=>{
          if(mode==="single") return 20;
          if(mode==="mixed") return 400;
          if(mode==="review") return pool.length||0;
          return 0;
        },[mode,pool]);
        
        const limit = useMemo(()=>{
          const raw = Number(questionLimit) || poolSize;
          if(mode==="review") return Math.min(raw, poolSize||0);
          return Math.min(raw, poolSize);
        },[questionLimit, poolSize, mode]);
        
        const keyFor = (a,b)=>`${a}x${b}`;
        const mistakeCount = (a,b)=> mistakeBank[keyFor(a,b)]||0;
        function recordMistake(a,b){ const k=keyFor(a,b); setMistakeBank(prev=>({...prev,[k]:(prev[k]||0)+1})); }
        function recordMastery(a,b){ const k=keyFor(a,b); setMistakeBank(prev=>{ const val=(prev[k]||0)-1; const next={...prev}; if(val>0) next[k]=val; else delete next[k]; return next; }); }
        
        function nextQuestion(resetCycle=false){
          if(!resetCycle && finished) return;
          let nextPair;
          if(mode==="review"){
            const weightedPool = pool.slice();
            if(!weightedPool.length){ setFinished(true); return; }
            const limitedPool = shuffle(weightedPool).slice(0, limit || weightedPool.length);
            nextPair = limitedPool[rand(0, limitedPool.length-1)];
          } else if(uniqueOnly){
            const used = new Set(asked.map(([x,y])=>keyFor(x,y)));
            const limitedPool = shuffle(pool).slice(0, limit);
            const remaining = limitedPool.filter(([a,b])=>!used.has(keyFor(a,b)));
            if(remaining.length===0){ setFinished(true); return; }
            nextPair = remaining[rand(0, remaining.length-1)];
          } else {
            const limitedPool = shuffle(pool).slice(0, limit);
            nextPair = limitedPool[rand(0, limitedPool.length-1)];
          }
          setCurrent({a: nextPair[0], b: nextPair[1]});
          setAnswer("");
          requestAnimationFrame(()=> inputRef.current?.focus());
        }
        
        function check(){
          const a = Number(current.a), b = Number(current.b);
          const correct = a*b;
          const given = Number(answer);
          const isCorrect = given===correct;
          setTotalAsked(n=>n+1);
          setAsked(xs=>[...xs,[a,b]]);
          if(isCorrect){ setCorrectCount(n=>n+1); if(mode==="review") recordMastery(a,b); }
          else { setWrong(xs=>[...xs,{a,b,given,correct}]); recordMistake(a,b); }
          setTimeout(()=>{
            const used = new Set(asked.map(([x,y])=>keyFor(x,y)).concat([keyFor(a,b)]));
            if(mode==="review"){
              const bankSize = Object.values(mistakeBank).reduce((s,n)=>s+(n||0),0);
              if(totalAsked+1>=(limit||0) || bankSize===0) setFinished(true); else nextQuestion();
              return;
            }
            if(uniqueOnly){
              const limitedPool = pool.slice(0, limit);
              const stillRemaining = limitedPool.some(([x,y])=>!used.has(keyFor(x,y)));
              if(!stillRemaining) setFinished(true); else nextQuestion();
            } else {
              if(totalAsked+1>=limit) setFinished(true); else nextQuestion();
            }
          },120);
        }
        
        function resetAll(){ setAsked([]); setWrong([]); setCorrectCount(0); setTotalAsked(0); setFinished(false); nextQuestion(true); }
        function startIfNeeded(){ if(totalAsked===0 && !finished){ nextQuestion(true); } }
        React.useEffect(()=>{ resetAll(); },[mode, selectedTable, uniqueOnly, questionLimit]);
        React.useEffect(()=>{ startIfNeeded(); inputRef.current?.focus(); },[]);
        
        const progress = Math.min((limit ? totalAsked/limit : 0),1);
        const scorePct = totalAsked>0 ? Math.round((correctCount/totalAsked)*100): 0;
        const bankTotalUnique = Object.keys(mistakeBank).length;
        const bankTotalWeighted = Object.values(mistakeBank).reduce((s,n)=>s+(n||0),0);
        
        return (
          <div style={{minHeight:'100vh'}}>
            <div className="container">
              <header style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'1.5rem'}}>
                <h1 style={{fontSize:'1.75rem',fontWeight:700}}>Tafels 1–20 Trainer</h1>
                <div className="row">
                  <button className="btn" onClick={()=>setMode('review')} disabled={bankTotalUnique===0} title={bankTotalUnique?'Oefen je fouten':'Geen fouten verzameld'}>Oefen fouten ({bankTotalUnique})</button>
                  <button className="btn primary" onClick={resetAll}>Herstart</button>
                </div>
              </header>
              <section className="grid" style={{marginBottom:'1.5rem'}}>
                <div className="card">
                  <label style={{display:'block',fontSize:'.9rem',fontWeight:600,marginBottom:'.5rem'}}>Modus</label>
                  <div className="row">
                    <button className={"btn "+(mode==='single'?'primary':'')} onClick={()=>setMode('single')}>Enkele tafel</button>
                    <button className={"btn "+(mode==='mixed'?'primary':'')} onClick={()=>setMode('mixed')}>Gemixte tafels</button>
                    <button className={"btn "+(mode==='review'?'primary':'')} onClick={()=>setMode('review')} disabled={bankTotalUnique===0}>Foutenbank</button>
                  </div>
                  {mode==='review' && <p style={{marginTop:'.5rem',fontSize:12,color:'#64748b'}}>Je oefent nu alleen sommen die je eerder fout had. Goed antwoord verlaagt de weging.</p>}
                </div>
                {mode==='single' && (
                  <div className="card">
                    <label style={{display:'block',fontSize:'.9rem',fontWeight:600,marginBottom:'.5rem'}}>Kies tafel</label>
                    <div className="chips">
                      {ALL_NUMBERS.map(n=> (<button key={n} className={"btn "+(Number(selectedTable)===n?'primary':'')} onClick={()=>setSelectedTable(n)}>{n}</button>))}
                    </div>
                    <p style={{marginTop:'.5rem',fontSize:12,color:'#64748b'}}>Je oefent {selectedTable} × 1 t/m 20.</p>
                  </div>
                )}
                <div className="card">
                  <label style={{display:'block',fontSize:'.9rem',fontWeight:600,marginBottom:'.5rem'}}>Aantal vragen</label>
                  <select value={questionLimit} onChange={e => setAnswer(e.target.value.replace(/[^0-9]/g,''))}>
                    {mode==='single' ? (<>
                      <option value={20}>20 (volledige tafel)</option>
                      <option value={10}>10</option>
                      <option value={5}>5</option>
                      <option value={40}>40</option>
                    </>) : mode==='mixed' ? (<>
                      <option value={20}>20</option>
                      <option value={50}>50</option>
                      <option value={100}>100</option>
                      <option value={200}>200</option>
                      <option value={400}>400 (alles)</option>
                    </>) : (<>
                      <option value={10}>10</option>
                      <option value={20}>20</option>
                      <option value={30}>30</option>
                      <option value={50}>50</option>
                    </>)}
                  </select>
                  {mode!=='review' && (
                    <label style={{display:'flex',alignItems:'center',gap:'.5rem',marginTop:'.5rem',fontSize:14}}>
                      <input type="checkbox" checked={uniqueOnly} onChange={e=>setUniqueOnly(e.target.checked)} />
                      Unieke sommen (geen herhaling)
                    </label>
                  )}
                </div>
                <div className="card">
                  <label style={{display:'block',fontSize:'.9rem',fontWeight:600,marginBottom:'.5rem'}}>Foutenbank</label>
                  <p style={{fontSize:14,color:'#334155'}}>Uniek: {bankTotalUnique} • Weging: {bankTotalWeighted}</p>
                  <div className="row" style={{marginTop:'.5rem',flexWrap:'wrap'}}>
                    <button className="btn" onClick={()=>setMode('review')} disabled={bankTotalUnique===0}>Oefen fouten</button>
                    <button className="btn" style={{borderColor:'#fecaca', color:'#b91c1c'}} onClick={()=>setMistakeBank({})} disabled={bankTotalUnique===0}>Leeg foutenbank</button>
                  </div>
                </div>
              </section>
              <section style={{marginBottom:'1.5rem'}}>
                <div style={{display:'flex',alignItems:'end',justifyContent:'space-between',marginBottom:'.5rem'}}>
                  <div><p style={{fontSize:14,color:'#475569'}}>Voortgang</p><p style={{fontSize:18,fontWeight:600}}>{limit ? `${totalAsked}/${limit}` : `${totalAsked}`}</p></div>
                  <div style={{textAlign:'right'}}><p style={{fontSize:14,color:'#475569'}}>Score</p><p style={{fontSize:18,fontWeight:600}}>{scorePct}%</p></div>
                </div>
                {limit ? <div className="progress"><div className="bar" style={{width: (progress*100)+'%'}}></div></div> : <p style={{fontSize:12,color:'#64748b'}}>Geen limiet ingesteld.</p>}
              </section>
              <main className="card">
                {!finished ? (<>
                  <div style={{textAlign:'center'}}>
                    <div style={{display:'inline-flex',alignItems:'center',gap:12}}>
                      <span style={{fontSize:42,fontWeight:600}}>{current.a}</span>
                      <span style={{fontSize:42}}>×</span>
                      <span style={{fontSize:42,fontWeight:600}}>{current.b}</span>
                    </div>
                    {mode==='review' && <p style={{marginTop:6,fontSize:12,color:'#64748b'}}>In foutenbank: {mistakeCount(current.a,current.b)}</p>}
                  </div>
                  <div style={{marginTop:'1rem',display:'flex',alignItems:'center',justifyContent:'center',gap:12}}>
                    <input ref={inputRef} inputMode="numeric" pattern="[0-9]*" placeholder="Antwoord" value={answer} onChange={e=>setAnswer(e.target.value.replace(/[^0-9]/g,''))} onKeyDown={e=>{ if(e.key==='Enter') check(); }} style={{width:160,textAlign:'center',fontSize:20,padding:'.75rem 1rem',borderRadius:12,border:'1px solid #cbd5e1'}} />
                    <button className="btn primary" onClick={check}>Controleer ↵</button>
                  </div>
                  <p style={{marginTop:6,textAlign:'center',fontSize:12,color:'#64748b'}}>Tip: druk op Enter om te controleren.</p>
                </>) : (<div style={{textAlign:'center'}}>
                  <h2 style={{fontSize:24,fontWeight:600,marginBottom:8}}>Klaar! 🎉</h2>
                  {mode==='review' ? <p style={{color:'#475569'}}>Goed bezig! Je foutenbank is bijgewerkt. Oefen nog een ronde of schakel terug naar een andere modus.</p> : <p style={{color:'#475569'}}>Je hebt {totalAsked} vragen beantwoord met {correctCount} goed ({scorePct}%).</p>}
                  <div style={{marginTop:12,display:'flex',alignItems:'center',justifyContent:'center',gap:12}}>
                    <button className="btn primary" onClick={resetAll}>Opnieuw starten</button>
                    {mode!=='review' && bankTotalUnique>0 && <button className="btn" onClick={()=>setMode('review')}>Oefen fouten</button>}
                  </div>
                </div>)}
              </main>
            </div>
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
